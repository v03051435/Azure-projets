trigger:
  branches:
    include:
      - testbed

pool:
  vmImage: ubuntu-latest

variables:
  acrName: yhaodevopsacr
  acrLoginServer: yhaodevopsacr.azurecr.io
  resourceGroup: rg-devops-demo

  containerEnvName: cae-devops-testbed

  apiImageName: repos-api
  webImageName: repos-web

  apiPath: AzureWebAp
  webPath: AzureReactApp

  # ===== versioning =====
  gitSha: $(Build.SourceVersion)
  shortSha: $[substring(variables['Build.SourceVersion'], 0, 7)]
  dateTag: build-$(Build.BuildId)

  # ===== branch -> env mapping =====
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    envName: prod
    apiAppName: demo-api-prod
    webAppName: demo-web-prod
    VITE_API_BASE_URL: https://demo-api-prod.livelyrock-263dd733.francecentral.azurecontainerapps.io
    VITE_ENV: Production
    ASPNETCORE_ENVIRONMENT: Production

  ${{ if eq(variables['Build.SourceBranchName'], 'testbed') }}:
    envName: testbed
    apiAppName: demo-api-testbed
    webAppName: demo-web-testbed
    VITE_API_BASE_URL: https://demo-api-testbed.livelyrock-263dd733.francecentral.azurecontainerapps.io
    VITE_ENV: Testbed
    ASPNETCORE_ENVIRONMENT: Testbed

stages:

# =====================
# STAGE 1 - BUILD
# =====================
- stage: build
  displayName: Build & Push Images
  jobs:
    - job: build_images
      displayName: Build API & Web
      steps:
        - checkout: self

        - task: AzureCLI@2
          displayName: Build & Push API + Web
          inputs:
            azureSubscription: sc-azure-rm
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -e
              echo "Environment: $(envName)"

              az acr login --name $(acrName)

              echo "=== API BUILD ==="
              docker build \
                -t $(acrLoginServer)/$(apiImageName):$(envName) \
                -t $(acrLoginServer)/$(apiImageName):git-$(shortSha) \
                -t $(acrLoginServer)/$(apiImageName):$(dateTag) \
                ./$(apiPath)

              docker push $(acrLoginServer)/$(apiImageName) --all-tags

              echo "=== WEB BUILD ==="
              echo "VITE_API_BASE_URL=$(VITE_API_BASE_URL)"

              docker build \
                -t $(acrLoginServer)/$(webImageName):$(envName) \
                -t $(acrLoginServer)/$(webImageName):git-$(shortSha) \
                -t $(acrLoginServer)/$(webImageName):$(dateTag) \
                ./$(webPath)

              docker push $(acrLoginServer)/$(webImageName) --all-tags

        # ===== Release Notes =====
        - script: |
            echo "## Release Notes" > release-notes.md
            git log -1 --pretty=format:"- %s (%an)" >> release-notes.md
          displayName: Generate Release Notes

        - task: PublishPipelineArtifact@1
          displayName: Publish Release Notes
          inputs:
            targetPath: release-notes.md
            artifact: release-notes

# =====================
# STAGE 2 - DEPLOY
# =====================
- stage: deploy
  displayName: Deploy to Container Apps
  dependsOn: build
  jobs:
    - job: deploy_apps
      displayName: Create or Update API & Web
      steps:
        - task: AzureCLI@2
          displayName: Deploy API & Web Container Apps
          inputs:
            azureSubscription: sc-azure-rm
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              set -e
              echo "Deploying environment: $(envName)"

              # ========= API =========
              if az containerapp show \
                --name $(apiAppName) \
                --resource-group $(resourceGroup) > /dev/null 2>&1; then

                echo "API exists → updating"
                az containerapp update \
                  --name $(apiAppName) \
                  --resource-group $(resourceGroup) \
                  --image $(acrLoginServer)/$(apiImageName):$(envName) \
                  --set-env-vars ASPNETCORE_ENVIRONMENT=$(ASPNETCORE_ENVIRONMENT)

              else
                echo "API not found → creating"
                az containerapp create \
                  --name $(apiAppName) \
                  --resource-group $(resourceGroup) \
                  --environment $(containerEnvName) \
                  --image $(acrLoginServer)/$(apiImageName):$(envName) \
                  --ingress external \
                  --target-port 8080 \
                  --env-vars ASPNETCORE_ENVIRONMENT=$(ASPNETCORE_ENVIRONMENT)
              fi

              # ========= WEB =========
              if az containerapp show \
                --name $(webAppName) \
                --resource-group $(resourceGroup) > /dev/null 2>&1; then

                echo "WEB exists → updating"
                az containerapp update \
                  --name $(webAppName) \
                  --resource-group $(resourceGroup) \
                  --image $(acrLoginServer)/$(webImageName):$(envName)

              else
                echo "WEB not found → creating"
                az containerapp create \
                  --name $(webAppName) \
                  --resource-group $(resourceGroup) \
                  --environment $(containerEnvName) \
                  --image $(acrLoginServer)/$(webImageName):$(envName) \
                  --ingress external \
                  --target-port 80
              fi
