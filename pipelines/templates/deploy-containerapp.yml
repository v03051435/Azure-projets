parameters:
  environment: 'Testbed/Production'
  imageTag: ''
  apiAppName: 'demo-api-prod/demo-api-testbed'
  webAppName: 'demo-web-prod/demo-web-testbed'
  apiBaseUrl: 'https://demo-api-prod.livelyrock-263dd733.francecentral.azurecontainerapps.io/https://demo-api-testbed.livelyrock-263dd733.francecentral.azurecontainerapps.io'

steps:
- task: AzureCLI@2
  displayName: Deploy API Container App
  inputs:
    azureSubscription: sc-azure-rm
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "Deploying API $(apiAppName) with tag $(imageTag)"

      az containerapp update \
        --name $(apiAppName) \
        --resource-group rg-devops-demo \
        --image yhaodevopsacr.azurecr.io/repos-api:$(imageTag) \
        --set-env-vars \
          ASPNETCORE_ENVIRONMENT=$(environment)

- task: AzureCLI@2
  displayName: Deploy WEB Container App
  inputs:
    azureSubscription: sc-azure-rm
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      echo "Deploying WEB $(webAppName) with tag $(imageTag)"

      az containerapp update \
        --name $(webAppName) \
        --resource-group rg-devops-demo \
        --image yhaodevopsacr.azurecr.io/repos-web:$(imageTag) \
        --set-env-vars \
          API_BASE_URL=$(apiBaseUrl) \
          VITE_ENV=$(environment)
