parameters:
  - name: environment
    type: string
    default: ''
  - name: imageTag
    type: string
    default: ''
  - name: apiAppName
    type: string
    default: ''
  - name: webAppName
    type: string
    default: ''
  - name: apiBaseUrl
    type: string
    default: ''

jobs:
- job: deploy
  displayName: Deploy to ${{ parameters.environment }}
  pool:
    vmImage: ubuntu-latest
  steps:
  - task: AzureCLI@2
    displayName: Deploy API & WEB
    inputs:
      azureSubscription: sc-azure-rm
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        echo "Deploying tag: ${{ parameters.imageTag }}"

        # Verify image tag exists in ACR before updating
        echo "Checking ACR for tag '${{ parameters.imageTag }}'..."
        api_exists=$(az acr repository show-tags --name yhaodevopsacr --repository repos-api --query "contains(@, '${{ parameters.imageTag }}')" -o tsv)
        if [ "$api_exists" != "true" ]; then
          echo "ERROR: API image tag '${{ parameters.imageTag }}' not found in registry repos-api"
          az acr repository show-tags --name yhaodevopsacr --repository repos-api --top 50 || true
          exit 1
        fi
        web_exists=$(az acr repository show-tags --name yhaodevopsacr --repository repos-web --query "contains(@, '${{ parameters.imageTag }}')" -o tsv)
        if [ "$web_exists" != "true" ]; then
          echo "ERROR: WEB image tag '${{ parameters.imageTag }}' not found in registry repos-web"
          az acr repository show-tags --name yhaodevopsacr --repository repos-web --top 50 || true
          exit 1
        fi

        # Verify Container Apps can pull from ACR (AcrPull role)
        rg=rg-devops-demo
        registryId=$(az acr show --name yhaodevopsacr --resource-group $rg --query id -o tsv)

        # API identity
        api_principal=$(az containerapp show --name ${{ parameters.apiAppName }} --resource-group $rg --query identity.principalId -o tsv || true)
        if [ -z "$api_principal" ]; then
          echo "WARNING: API Container App has no managed identity; ensure registry credentials or system assigned identity with AcrPull"
        else
          api_assigned=$(az role assignment list --assignee "$api_principal" --scope "$registryId" --query "[?roleDefinitionName=='AcrPull'] | length(@)" -o tsv)
          if [ "$api_assigned" = "0" ]; then
            echo "ERROR: API Container App principal '$api_principal' lacks AcrPull on registry. Run: az role assignment create --assignee $api_principal --role AcrPull --scope $registryId"
            exit 1
          fi
        fi

        # WEB identity
        web_principal=$(az containerapp show --name ${{ parameters.webAppName }} --resource-group $rg --query identity.principalId -o tsv || true)
        if [ -z "$web_principal" ]; then
          echo "WARNING: WEB Container App has no managed identity; ensure registry credentials or system assigned identity with AcrPull"
        else
          web_assigned=$(az role assignment list --assignee "$web_principal" --scope "$registryId" --query "[?roleDefinitionName=='AcrPull'] | length(@)" -o tsv)
          if [ "$web_assigned" = "0" ]; then
            echo "ERROR: WEB Container App principal '$web_principal' lacks AcrPull on registry. Run: az role assignment create --assignee $web_principal --role AcrPull --scope $registryId"
            exit 1
          fi
        fi

        # ===== API =====
        az containerapp update \
          --name ${{ parameters.apiAppName }} \
          --resource-group $rg \
          --image yhaodevopsacr.azurecr.io/repos-api:${{ parameters.imageTag }} \
          --set-env-vars \
            ASPNETCORE_ENVIRONMENT=${{ parameters.environment }}

        # ===== WEB =====
        az containerapp update \
          --name ${{ parameters.webAppName }} \
          --resource-group $rg \
          --image yhaodevopsacr.azurecr.io/repos-web:${{ parameters.imageTag }} \
          --set-env-vars \
            API_BASE_URL=${{ parameters.apiBaseUrl }} \
            VITE_ENV=${{ parameters.environment }}
