trigger: none

resources:
  pipelines:
    - pipeline: test_build
      source: pipeline-test
      trigger: none

stages:
- stage: promote_prod
  displayName: Promote to PROD

  jobs:
  # =====================================================
  # JOB 1 - Resolve image tag + release notes
  # =====================================================
  - job: prepare
    displayName: Resolve tag & release notes
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - download: test_build
      artifact: image-info

    - bash: |
        set -e
        tag=$(jq -r .tag $(Pipeline.Workspace)/test_build/image-info/image.json)
        if [ -z "$tag" ] || [ "$tag" = "null" ]; then
          echo "ERROR: Cannot resolve image tag from artifact"
          exit 1
        fi

        echo "Resolved tag=$tag"

        # Current job variable
        echo "##vso[task.setvariable variable=ResolvedImageTag]$tag"
        # Output variable for downstream jobs
        echo "##vso[task.setvariable variable=imageTag;isOutput=true]$tag"
      name: resolve
      displayName: Resolve image tag

    - bash: |
        set -euo pipefail
        echo "Tagging images as 'prod' and pushing to ACR..."
        tag="${ResolvedImageTag:-${IMAGE_TAG:-}}"
        if [ -z "$tag" ]; then
          echo "ERROR: IMAGE_TAG is not set and ResolvedImageTag is empty"
          exit 1
        fi
        acrServer="${acrLoginServer:-$ACRLOGINSERVER}"
        acrName="${acrName:-$ACRNAME}"

        az acr login --name "${acrName}"

        for svc in $(jq -r '.services | keys[]' pipelines/services.json); do
          repoName=$(jq -r ".services[\"$svc\"].repo" pipelines/services.json)
          if [ -n "$repoName" ] && [ "$repoName" != "null" ]; then
            echo "Processing $repoName"

            # Pre-flight: verify the source tag exists in ACR before pulling
            query="contains(@, '${tag}')"
            if [ "$(az acr repository show-tags --name "${acrName}" --repository "$repoName" --query "$query" -o tsv)" != "true" ]; then
              echo "ERROR: Source tag '${tag}' not found in repository '${repoName}' in ACR '${acrName}'"
              exit 1
            fi

            docker pull "${acrServer}/${repoName}:${tag}"
            docker tag "${acrServer}/${repoName}:${tag}" "${acrServer}/${repoName}:prod"
            docker push "${acrServer}/${repoName}:prod"

            # Verify the 'prod' tag exists in ACR for this repository
            query="contains(@, 'prod')"
            if [ "$(az acr repository show-tags --name "${acrName}" --repository "$repoName" --query "$query" -o tsv)" != "true" ]; then
              echo "ERROR: 'prod' tag not found for $repoName after push"
              exit 1
            fi
          fi
        done
      displayName: Tag images as 'prod' and push

    - bash: |
        set -e
        git fetch --tags --prune || true
        git log -n 30 --pretty=format:"%h %s" > release-notes.txt
        echo "" >> release-notes.txt
        echo "Image tag: $(ResolvedImageTag)" >> release-notes.txt
        cat release-notes.txt
      displayName: Generate release notes

    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: release-notes.txt
        artifact: release-notes

  # =====================================================
  # DEPLOYMENT JOB - Deploy PROD (with Approval)
  # =====================================================
  - deployment: deploy_prod
    displayName: Deploy to PROD
    dependsOn: prepare
    environment: prod
    pool:
      vmImage: ubuntu-latest

    variables:
      finalImageTag: $[ dependencies.prepare.outputs['resolve.imageTag'] ]

    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - template: templates/service-deployer.yml
            parameters:
              action: deploy
              tag: $(finalImageTag)
              env: prod
              servicesFile: pipelines/services.json

  # =====================================================
  # JOB 3 - Cleanup old ACR tags (keep latest 5)
  # =====================================================
  - job: cleanup_acr
    displayName: Cleanup old ACR tags
    dependsOn: deploy_prod
    condition: succeeded()
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Prune old image tags (keep 10 per repo)
      inputs:
        azureSubscription: 'sc-azure-rm'
        scriptType: 'pscore'
        scriptLocation: 'scriptPath'
        scriptPath: '$(System.DefaultWorkingDirectory)/pipelines/scripts/prune_acr_tags.ps1'
        scriptArguments: '-Keep 10'
