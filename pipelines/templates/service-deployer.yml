parameters:
- name: action
  type: string
  default: deploy
- name: tag
  type: string
  default: ''
- name: acrName
  type: string
  default: yhaodevopsacr
- name: acrLoginServer
  type: string
  default: yhaodevopsacr.azurecr.io
- name: rg
  type: string
  default: rg-devops-demo
- name: env
  type: string
  default: testbed
- name: servicesFile
  type: string
  default: pipelines/services.json
- name: dryRun
  type: boolean
  default: false

steps:
- task: AzureCLI@2
  ${{ if eq(parameters.action, 'deploy') }}:
    displayName: Deploy services
  ${{ else }}:
    displayName: Rollback services
  inputs:
    azureSubscription: sc-azure-rm
    scriptType: bash
    scriptLocation: inlineScript
    ${{ if eq(parameters.dryRun, true) }}:
      inlineScript: |
        python pipelines/scripts/deploy.py \
          --action "${{ parameters.action }}" \
          --tag "${{ parameters.tag }}" \
          --acr-name "${{ parameters.acrName }}" \
          --acr-login-server "${{ parameters.acrLoginServer }}" \
          --rg "${{ parameters.rg }}" \
          --env "${{ parameters.env }}" \
          --services-file "${{ parameters.servicesFile }}" \
          --dry-run
    ${{ else }}:
      inlineScript: |
        python pipelines/scripts/deploy.py \
          --action "${{ parameters.action }}" \
          --tag "${{ parameters.tag }}" \
          --acr-name "${{ parameters.acrName }}" \
          --acr-login-server "${{ parameters.acrLoginServer }}" \
          --rg "${{ parameters.rg }}" \
          --env "${{ parameters.env }}" \
          --services-file "${{ parameters.servicesFile }}"
